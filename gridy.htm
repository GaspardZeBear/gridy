<!doctype html>
<html lang="fr">
<head>
<title>Grid</title>
<meta charset="utf-8">
<script>

window.onload= function() {
//imgFile="gridy.png";
gridy = {
  step: parseInt(document.getElementById("iStep").value),
  prop: parseInt(document.getElementById("iProp").value),
  split: parseInt(document.getElementById("iSplit").value),
  zoom: parseFloat(document.getElementById("iZoom").value),
  zoomProp:{min:0.1,max:10},
  imgUrl: document.getElementById("iImgUrl").value,
  imgFile: document.getElementById("iImgFile").value,
  propWidth: parseFloat(document.getElementById("iPropWidth").value),
  stepWidth: parseFloat(document.getElementById("iStepWidth").value), 
  target: {}, 
  get : function(pName) { return(this[pName]) ; },
  setInt : function(pName) { this[pName]=parseInt(document.getElementById("i"+pName.charAt(0).toUpperCase() + pName.slice(1)).value) ; },
  setFloat : function(pName) { this[pName]=parseFloat(document.getElementById("i"+pName.charAt(0).toUpperCase() + pName.slice(1)).value) ; },
  setString : function(pName) { this[pName]=document.getElementById("i"+pName.charAt(0).toUpperCase() + pName.slice(1)).value ; },
  incr : function(pName,val) {
         var r=gridy[pName] + val;
         //var limits=gridy[pName+"Prop"];
         //if ( r <= limits.max && r >= limits.min  ) {
         gridy[pName] = r ;
         document.getElementById("i"+pName.charAt(0).toUpperCase() + pName.slice(1)).value = gridy[pName]; 
           
  },
} ;
 
 
var c = document.getElementById("gridCanvas");
c.addEventListener("mousedown", doMouseDown, false);
c.addEventListener("mouseup", doMouseUp, false);
document.getElementById("iZoom").onchange= function() { gridy.setFloat("iZoom") ;x()};
document.getElementById("iStep").onchange=function() { gridy.setInt("iStep");x()};
document.getElementById("iProp").onchange=function() { gridy.setInt("iProp") ;x()};
document.getElementById("iSplit").onchange=function() { gridy.setInt("iSplit") ;x()};
document.getElementById("iImgUrl").onchange=function() { gridy.setString("iImgFile") ;x()};
document.getElementById("iStepWidth").onchange= function() { gridy.setFloat("iStepWidth") ;x()};
document.getElementById("iPropWidth").onchange= function() { gridy.setFloat("iPropWidth") ;x()};
x();
}



function doMouseDown(event) {
var pos = getMousePos(this, event);
gridy.target.x0=pos.x;
gridy.target.y0=pos.y;
gridy.target.x1=pos.x;
gridy.target.y1=pos.y;
}

function doMouseUp(event) {
var pos = getMousePos(this, event);
gridy.target.x2=pos.x;
gridy.target.y2=pos.y;
gridy.target.x1=Math.abs(gridy.target.x1+gridy.target.x2)/2;
gridy.target.y1=Math.abs(gridy.target.y1+gridy.target.y2)/2;
gridy.target.dialen= Math.sqrt(Math.pow(gridy.target.x1-gridy.target.x2,2) + Math.pow(gridy.target.y1-gridy.target.y2,2));
draw();
}

function getMousePos(canvas, e) {
   var rect = canvas.getBoundingClientRect();
    return {x: (e.clientX - rect.left)/gridy.get("zoom"), y: (e.clientY - rect.top)/gridy.get("zoom")};
}

function draw() {
  x();
}


function handleFile(f) {
  gridy.imgFile=f[0].name;
  x();
}

function addZoom(val) {
  gridy.zoom+=val;
  document.getElementById("iZoom").value = gridy.get("zoom");
  x();
}

function addPropWidth(val) {
  gridy.propWidth+=val;
  document.getElementById("iPropWidth").value = gridy.propWidth;
  x();
}

function addStepWidth(val) {
  gridy.stepWidth+=val;
  document.getElementById("iStepWidth").value = gridy.stepWidth;
  x();
}

function addStep(val) {
  if ( gridy.step + val < 20) {
     return;
  }
  gridy.step+=val;
  document.getElementById("iStep").value = gridy.step;
  x();
}

function addProp(val) {
  if ( gridy.prop + val < 2) {
     return;
  }
  gridy.prop+=val;
  document.getElementById("iProp").value = gridy.prop;
  x();
}

function addSplit(val) {
  if ( gridy.get("split") + val < 2) {
     return;
  }
  gridy.split+=val;
  document.getElementById("iSplit").value = gridy.get("split");
  x();
}

function x() {
     var img = new Image();
        img.onload = function() {
        loadCanvas(img);
        };
     img.src=gridy.imgFile ;
}

function drawTarget(ctx) {
    //console.log("drawTarget X1="+target.x1 + " Y1="+target.y1 + " X2="+target.x2 + " Y2="+target.y2);
    ctx.beginPath();
    ctx.moveTo(gridy.target.x0*gridy.get("zoom"),gridy.target.y0*gridy.get("zoom"));
    ctx.lineTo(gridy.target.x2*gridy.get("zoom"),gridy.target.y2*gridy.get("zoom"));
    //ctx.moveTo(target.x1*gridy.get("zoom"),target.y1*gridy.get("zoom"));
    //ctx.lineTo(target.x2*gridy.get("zoom"),target.y2*gridy.get("zoom"));
    ctx.arc(gridy.target.x1*gridy.get("zoom"),gridy.target.y1*gridy.get("zoom"),2,0,2*Math.PI);
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'green';
    ctx.stroke();
    ctx.closePath();


    //var d= Math.sqrt(Math.pow(target.x1*gridy.get("zoom")-target.x2*gridy.get("zoom"),2) + Math.pow(target.y1*gridy.get("zoom")-target.y2*gridy.get("zoom"),2));
    var d= gridy.target.dialen*gridy.get("zoom");
    console.log("d="+d);
    inc=d/gridy.get("split");
    r=0;
    while ( r< d) {
      ctx.beginPath();
      r+=inc;
      ctx.arc(gridy.target.x1*gridy.get("zoom"),gridy.target.y1*gridy.get("zoom"),r,0,2*Math.PI);
      ctx.stroke();
      ctx.closePath();
    } 
}

function drawGrid(ctx,xsize,ysize,cxsize,cysize,color,step,factor,width) {
    console.log("drawGrid : xsize="+xsize+" ysize="+ysize+" color="+color+" step="+step+" factor="+factor+" width="+width) ;
    ctx.beginPath();
    ctx.font="20px Georgia";
    ctx.strokeStyle=color;
    if (width <= 0 ) {
      return;
    }
    ctx.lineWidth=width;
    console.log(gridy.get('step'));
    xStep=step;
    yStep=step;
    if (step == 0) {
      xStep=Math.round(xsize/factor);
      yStep=Math.round(ysize/factor);
    }
    for (i=0;i<xsize;i+=xStep) {
      ctx.moveTo(i,0);
      ctx.lineTo(i,ysize);
      ctx.stroke();
    }
    for (i=0;i<ysize;i+=yStep) {
      ctx.moveTo(0,i);
      ctx.lineTo(xsize,i);
      ctx.stroke();
    }
    count=1;
    for (i=step;i<cxsize;i+=step) {
      ctx.fillText(count,i+step/2,step/2);
      count++;
    }
    count=1;
    for (i=step;i<cysize;i+=step) {
      ctx.fillText(count,step/2,i+step/2);
      count++;
    }
     ctx.closePath();
}

function loadCanvas(img) {
    //alert("loadCanvas");   
    var c = document.getElementById("gridCanvas");
    c.width= img.width*gridy.get("zoom");
    c.height = img.height*gridy.get("zoom");
    xRatio= c.width/img.width;
    yRatio= c.height/img.height;
    ratio=xRatio;
    if ( yRatio < ratio)  {
       ratio=yRatio;
    }
    var ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0, img.width*ratio, img.height * ratio);
    drawGrid(ctx,img.width*ratio, img.height * ratio,c.width,c.height,'black',gridy.step,0,gridy.stepWidth);
    drawGrid(ctx,img.width*ratio, img.height * ratio,0,0,'red',0,gridy.prop,gridy.propWidth);
    drawTarget(ctx);
    
};

</script>

</head>
<body>
<table border>
<tr><td>
Local file<input type="file" accept=".jpg, .jpeg, .png" id="iImgFile" value="gridy.png" onchange="handleFile(this.files)">
<br/>Url <input type="text" id="iImgUrl">
</td></tr>
<tr><td>Zoom<input type="text" id="iZoom" value="1">
<input type="button" id=="zoomIncr" value="+" onClick="addZoom(0.1)">
<input type="button" id="zoomDecr" value="-" onClick="addZoom(-0.1)">
<br/>Split<input type="text" id="iSplit" value="4">
<input type="button" id=="splitIncr" value="+" onClick="addSplit(1)">
<input type="button" id="splitDecr" value="-" onClick="addSplit(-1)">
<br/>Step<input type="text" id="iStep" value="40">
<input type="button" id=="stepIncr" value="+" onClick="addStep(10)">
<input type="button" id="stepDecr" value="-" onClick="addStep(-10)">
stepWidth<input type="text" id="iStepWidth" value="1">
<input type="button" id=="widthStepIncr" value="+" onClick="addStepWidth(0.1)">
<input type="button" id="widthStepDecr" value="-" onClick="addStepWidth(-0.1)">
<br/>
Proportion<input type="text" id="iProp" value="3">
<input type="button" id=="propIncr" value="+" onClick="addProp(1)">
<input type="button" id="propDecr" value="-" onClick="addProp(-1)">
propWidth<input type="text" id="iPropWidth" value="1">
<input type="button" id=="widthPropIncr" value="+" onClick="addPropWidth(0.1)">
<input type="button" id="widthPropDecr" value="-" onClick="addPropWidth(-0.1)">
</td></tr>
</table>
<table>
<tr><td><canvas id="gridCanvas"> </canvas></td></tr>
</table>
</html>
